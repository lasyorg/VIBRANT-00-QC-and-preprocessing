---
title: "VIBRANT Luminex QC - batch 1"
author: Laura Symul
date: today
format: 
   html:
     page-layout: full
     code-fold: true
     toc: true
     toc-location: left
     toc-depth: 5
     embed-resources: true
execute:
  cache: refresh # true refresh false
  warning: false
knitr:
  opts_chunk:
    out.width: "100%"
editor: source
---

```{r}
#| warning: false

library(tidyverse)
library(magrittr)
library(gt)
library(patchwork)
library(SummarizedExperiment)
library(tidySummarizedExperiment)

tmp <- fs::dir_map("R scripts Luminex/", source)

theme_set(theme_light())

```

# Data

## Loading Luminex data

```{r}

VIBRANT_dropbox_dir <-
  "/Users/laurasymul/Dropbox/Academia/Projects/VIBRANT Study Files/"

luminex_dir <- 
  str_c(VIBRANT_dropbox_dir, "15_VIBRANT Luminex/VMRC VIBRANT LUMINEX Results_ONGOING")

```

```{r}

plate_dirs <- list.files(luminex_dir, full.names = TRUE, pattern = "late [0-9]")

```

The data for the first `r length(plate_dirs)` plates were uploaded to the VIBRANT Dropbox by Lenine Liebenberg in February 2025 in the following directories:

```{r}
plate_dirs |> str_remove(".*Projects/")
```

The data was made available as excel files. In these directories, we find the following files:

```{r}

files <- list.files(plate_dirs, full.names = FALSE, pattern = "xlsx$")
files

```


::: callout-note
We only consider files that are of the form `[date]_SFT_LUM_VIBRANT_plate [0-9]*.xlsx` (*i.e.,* not considering the "unoptimized" or other files). 
:::

We load this data into R and store the excel sheets from the different plates in a single `SummarizedExperiment` object.

```{r}

raw <- 
  read_luminex_excels(
    dirs = plate_dirs,
    pattern = "SFT_LUM_VIBRANT_plate [0-9]*\\.xlsx$",
    name = "VIBRANT batch 1"
    ) # 

raw

```

## Plate design and sample names

```{r}
#| fig-width: 12
#| fig-height: 5
#| fig-dpi: 300
plot_plate_design(raw) 

```

::: callout-note
Sample names on plate 1 are different than the sample names on all other plates. We can harmonize that using the `Plate Layouts.xlsx` files that matches both format. 
:::



::: callout-note
There was a typo for the sample name of well A5 on plate 4 (`LO[`). We fix that sample name using the info found in `Plate Layouts.xlsx`. (It should be sample  `SA_068-20-0153_V1_1000`/`6_14_23sa01`)
:::


```{r}

raw <- 
  raw |> 
  mutate(
    sample_id = 
      case_when(
        sample_id == "LO[" ~ "SA_068-20-0153_V1_1000",
        TRUE ~ sample_id
      )
  )

```

```{r}

samples <- 
  raw |> 
  as_tibble() |> 
  select(.sample, sample_type, sample_id) |> 
  distinct()

```

::: callout-note
There is also a small mismatch in the names of biological controls between different plates: we fix the `sample_id` to be `BIOL CTRL` everywhere.
:::

```{r}

samples |> filter(sample_id |> str_detect("CTRL")) |> dplyr::count(sample_id)

```

```{r}

raw <- 
  raw |> 
  mutate(sample_id = sample_id |> str_replace_all("BIO CTRL", "BIOL CTRL"))

```


```{r}

raw <- 
  raw |> 
  mutate(
    sample_type = 
      case_when(
        str_detect(sample_id, " CTRL") ~ "Positive control", 
        TRUE ~ sample_type
        )
    )

```


```{r}
rm(samples)
```


## Loading manifest data

We load the data contained in the first sheet (`Plating`) from the `Plate Layouts.xlsx` file.
At the moment, we only consider the data in `A2:X372`.

```{r}

manifest <- 
  read_xlsx(
    str_c(luminex_dir, "/Plate Layouts.xlsx"), 
    sheet = "Plating", range = "A2:X372"
  )

```

```{r}

manifest_col <- c("Sample_Vcode", "shorthand title", "alternate title", "Location", "Weight", "Volume", "Volume added for assay", "Round 1 Final dilution factor")

```


We subset and rename the column of interest (`r manifest_col |> str_c(collapse = ", ")`):

```{r}

manifest <- 
  manifest |> 
  select(manifest_col) |> 
  dplyr::rename(
    sample_vcode = Sample_Vcode,
    shorthand_title = `shorthand title`,
    sample_id = `alternate title`,
    location = Location,
    weight = Weight,
    volume = Volume,
    volume_added_for_assay = `Volume added for assay`,
    dilution_manifest = `Round 1 Final dilution factor`
  )

manifest |> head() |> gt(caption = "Top rows of the manifest data after column selection and renaming.")

```

We rename the plate 1 `sample_id` to match the actual (manifest) `sample_id`.

```{r}

samples <- 
  colData(raw) |> 
  as.data.frame() |> 
  rownames_to_column(".sample") |> 
  as_tibble()

samples <-
  samples |> 
  left_join(
    manifest |> 
      select(shorthand_title, sample_id) |> 
      dplyr::rename(sample_id_manifest = sample_id, sample_id = shorthand_title),
    by = join_by(sample_id)
  )

should_be_zero <- 
  samples |> 
  filter((plate_nb != 1) & !is.na(sample_id_manifest)) |> 
  nrow()

if (should_be_zero > 0) 
  stop("There are samples with a manifest sample_id that are not on plate 1")


samples <-
  samples |> 
  mutate(
    sample_id =
      case_when(
        !is.na(sample_id_manifest) ~ sample_id_manifest,
        TRUE ~ sample_id
      )
  )
  
```

```{r}

samples <- 
  samples |> 
  left_join(manifest, by = join_by(sample_id))

raw$sample_id <- samples$sample_id

```



Now that `sample_id` are fixed and consistent across samples and plates, we create a `pid` (participant id), `visit_nb`, and `location` column with info extracted from the `sample_id`.

```{r}

raw$pid <- 
  ifelse(
    str_detect(raw$sample_id, "^US|^SA"), 
    raw$sample_id |> str_remove("SA_068-20-|US_068-10-") |> str_remove("_V[0-9].*"), 
    NA
    )
raw$visit_nb <- 
  raw$sample_id |> str_extract("V[0-9]*") |> str_remove("V") |> as.integer()
raw$location <- raw$sample_id |> str_extract("^US|^SA") |> factor()

```

#### Sample weight, volume, and dilution factors

We also , `weight`, `volume`, `volume_added_for_assay`, and `dilution_manifest` columns in the `colData(raw)` data.

```{r}


# raw$location_manifest <- samples$location # these are the same
raw$dilution_manifest <- samples$dilution_manifest
raw$weight <- samples$weight
raw$volume <- samples$volume
raw$volume_added_for_assay <- samples$volume_added_for_assay

rm(samples)

```


We compare the dilution factors from the excel file and the manifest:

```{r}
#| fig-width: 10
#| fig-height: 5

colData(raw) |> 
  as.data.frame() |> 
  rownames_to_column(".sample") |>
  as_tibble() |>
  ggplot() +
  aes(x = dilution, y = dilution_manifest, col = plate_name) +
  geom_abline(intercept = 0, slope = 1, col = "gray80") +
  geom_point(alpha = 0.5, size = 0.2) +
  coord_fixed() +
  labs(
    x = "Dilution factor from Luminex excel file\n(dilution sheet)", 
    y = "Dilution factor from manifest\nRound 1 Final dilution factor",
    color = "Plate"
    ) +
  facet_wrap(plate_name |> str_replace_all("_", " ") |> str_wrap(20) ~ ., nrow = 2) +
  guides(col = "none")
 
```
::: callout-note
The dilution factors have been rounded to the lowest integer. This will be fixed shortly.
:::



::: callout-caution
In SA, the **volume** of samples were not collected, only the samples' **weight**.
:::


```{r}

dilution_related_data <- 
  colData(raw) |> 
  as.data.frame() |>
  rownames_to_column(".sample") |>
  as_tibble() |>
  filter(sample_type == "Sample") |> 
  select(sample_id, location, pid, visit_nb, dilution, dilution_manifest, weight, volume) 

```


```{r}
location_colors <- c("US" = "coral", "SA" = "steelblue3")
```


```{r}
#| fig-width: 10
#| fig-height: 5

dilution_related_data |> 
  ggplot() +
  aes(x = weight, fill = location) +
  geom_histogram(bins = 50, alpha = 0.5, position = "identity") +
  scale_fill_manual(values = location_colors) +
  xlab("Sample weight") +
  ylab("n samples") +
  
  dilution_related_data |> 
  ggplot() +
  aes(x = volume, fill = location) +
  geom_histogram(bins = 50, alpha = 0.5, position = "identity")  +
  scale_fill_manual(values = location_colors) +
  guides(fill = "none") +
  xlab("Sample volume") +
  ylab("n samples") +
  
  plot_layout(guides = "collect")


```

::: callout-note
Lenine has assumed that 1g = 1mL for **all** samples to compute the final dilution factors.
:::

However, when we examine the relationship between weight and volume in the US samples, we not not observe data compatible with that assumption:

```{r}

g_exact <- 
  dilution_related_data |> 
  ggplot() +
  aes(y = volume, x = weight, col = location) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(alpha = 0.1) + 
  coord_fixed() +
  scale_color_manual(values = location_colors) +
  guides(col = "none") 

g_jittered <-   
  dilution_related_data |> 
  ggplot() +
  aes(y = volume, x= weight, col = location) +
  geom_abline(intercept = 0, slope = 1) +
  geom_jitter(height = 0.025, width = 0.025, size = 0.5, alpha = 0.5) +
  coord_fixed() +
  scale_color_manual(values = location_colors)

```


```{r}
#| fig-height: 12
#| fig-width: 8

mod <- lm(volume ~ weight, data = dilution_related_data)
mod_label <- str_c("V = ", mod$coefficients[2] |> round(2), "W + ",mod$coefficients[1] |> round(2))

mod_color <- "purple"

g_exact + 
  annotate(geom = "text", x = 1, y = 1, label = "1mL = 1g", col = "black", hjust = -0.1) +
    ggtitle("(Exact coordinates)") +
  g_jittered +
  ggtitle("(Jittered coordinates)") +
  
  g_exact + 
  geom_abline(slope = 1, intercept = 0.4, col = mod_color) + 
  annotate(geom = "text", x = 0.8, y = 1.2, label = "V = W + 0.4", col = mod_color, hjust = 1.1, vjust = 0) +
  ggtitle("Systematic bias in weight measurements") +
  g_jittered + 
  geom_abline(slope = 1, intercept = 0.4, col = mod_color) + 
  annotate(geom = "text", x = 0.8, y = 1.2, label = "V = W + 0.4", col = mod_color, hjust = 1.1, vjust = 0) +
  
  g_exact + 
  geom_abline(slope = mod$coefficients[2], intercept = mod$coefficients[1], col = mod_color) + 
  annotate(geom = "text", x = 1, y = 1.2, label = mod_label, col = mod_color, hjust = 1.1, vjust = 0) +
  ggtitle("Linear relationship between volume and weight") +
  g_jittered + 
  geom_abline(slope = mod$coefficients[2], intercept = mod$coefficients[1], col = mod_color) + 
  annotate(geom = "text", x = 1, y = 1.2, label = mod_label, col = mod_color, hjust = 1.1, vjust = 0) +
  
  
  g_exact + 
  geom_smooth(method = "lm", formula = "y ~ x + I(x^2)", se = FALSE, col = mod_color) +
  ggtitle("Quadratic relationship between volume and weight") +
  g_jittered + 
   geom_smooth(method = "lm", formula = "y ~ x + I(x^2)", se = FALSE, col = mod_color) +
  
  plot_layout(guides = "collect", ncol = 2)


```

If we assume that the quadratic relationship between volume and weight observed in the US is generalizeable to SA samples, we can impute the SA samples' volume using the quadratic model, then, recalculate the dilution factors.

```{r}

mod2 <- lm(volume ~ weight + I(weight^2), data = dilution_related_data |> filter(location == "US"))
pred_volume <- predict(mod2, newdata = tibble(weight = raw$weight))
raw$volume_imputed <- ifelse((raw$location == "SA") & (raw$sample_type == "Sample"), pred_volume, raw$volume)

```


```{r}

raw <- 
  raw |> 
  mutate(
    dilution_aliquot = (volume_imputed + 0.5)/volume_imputed,
    dilution_sample = (200 + volume_added_for_assay)/(200),
    dilution_imputed = dilution_aliquot * dilution_sample
  )

```

```{r}

dilution_related_data <- 
  colData(raw) |> 
  as.data.frame() |>
  rownames_to_column(".sample") |>
  as_tibble() |>
  filter(sample_type == "Sample") |> 
  select(sample_id, location, pid, visit_nb, dilution, dilution_manifest, dilution_imputed, weight, volume, volume_imputed)

```

```{r}

dilution_related_data |> 
  filter(location == "SA", dilution_imputed < 3, dilution > 10)

```


```{r}

ggplot(dilution_related_data) +
  aes(x = dilution_manifest, y = dilution_imputed, col = location) +
  geom_point(alpha = 0.5, size = 0.5) +
  scale_color_manual(values = location_colors) +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Dilution (manifest values)") +
  ylab("Dilution (imputed values)\ncomputed from actual volumes in the US\nand imputed volumes in SA") +
  coord_fixed()

```
```{r}

ggplot(dilution_related_data) +
  aes(x = dilution_manifest, y = dilution_imputed, col = weight |> log2(), shape = location) +
  geom_point(alpha = 0.5, size = 0.8) +
  scale_color_gradient(low = "red", high = "black") +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Dilution (manifest values)") +
  ylab("Dilution (imputed values)\ncomputed from actual volumes in the US\nand imputed volumes in SA") +
  coord_fixed()

```


::: callout-caution
There are marked differences between the dilution values as computed from the sample weight and those using the actual or imputed volume... The largest differences are observed when the measured weights were very small... Something to discuss :)

For now, I continue the analyses with the rounded dilution values that were provided in the excel files, but at the end of the document, I've done some of the analyses again using the imputed dilution values. I think that what would be the best course of action is to NOT provide the dilutions to the Luminex software, but rely on it for the standards calibration, then import that data here, impute the out-of-range values, then multiply these "unadjusted" concentrations by the computed/imputed dilution factors and obtain our final estimates for the dilution-adjusted concentrations.

The alternative would be to compute/impute the dilution factors first, provide them to the Luminex software, then import the data here and proceed with the analyses. This might actually be simpler, but less flexible as the person running the code would depend on the person running the Luminex software to obtain the concentrations.
:::


So, for now, the current dilution values per plate and sample are:

```{r}
#| fig-height: 12

raw |> plot_dilution_factors()

```



## Number of replicates per location, participants, and visits

```{r}
#| fig-height: 6
#| fig-width: 7

# colData(raw) |> 
#   as.data.frame() |> 
#   dplyr::count(location, pid, visit_nb) |> 
#   filter(!is.na(pid), !is.na(visit_nb)) |> 
#   pivot_wider(names_from = visit_nb, values_from = n, names_prefix = "V", values_fill = 0) |> 
#   gt(caption = "Number of samples per location, participant, and visit.")

colData(raw) |> 
  as.data.frame() |> 
  dplyr::count(location, pid, visit_nb) |> 
  filter(!is.na(pid), !is.na(visit_nb)) |>
  arrange(visit_nb) |> 
  mutate(
    visit = str_c("V", visit_nb) |> fct_inorder(),
    n = n |> factor()
    ) |>
  ggplot(aes(x = visit, y = pid, fill = n)) +
  geom_tile() +
  facet_wrap(. ~ location, scales = "free") +
  scale_fill_manual(name = "Number of samples", values = c("steelblue1", "steelblue3")) +
  ylab("Participant IDs")

```




## Standard curves

```{r}
#| fig-width: 18
#| fig-height: 10

raw |> plot_standard_curves() 

```


```{r}
#| fig-width: 8
#| fig-height: 5

raw |> filter(.feature %in% "Hu IL-7 (74)") |> 
  plot_standard_curves() + facet_wrap(. ~ plate_name + .feature) + guides(col = "none") +
  ggtitle("Standard curves for Hu IL-7 (74)")

```

```{r}
#| fig-height: 10
#| fig-width: 10

blanks <- 
  raw |> 
  as_tibble() |> 
  filter(sample_type == "Blank") 

raw |> 
  as_tibble() |> 
  filter(sample_type == "Standard") |> 
  mutate(sample_id = sample_id |> factor(levels = str_c("S", 1:10))) |>
  ggplot() +
  aes(x = .feature, y = FI, col = plate_nb |> factor()) +
  geom_hline(yintercept = 1, linetype = 1) +
  geom_point(data = blanks |> select(.feature, plate_nb, FI), alpha = 0.5, size = 0.5, col = "black") +
  geom_point(alpha = 0.5, size = 0.9) +
  facet_grid(sample_id ~ str_c("plate: ", plate_nb), scales = "free_y") +
  guides(col = "none") +
  scale_y_log10("Fluorescence intensity") +
  scale_x_discrete("Analytes", breaks = NULL) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(caption = "Colored dots correspond to wells with standards, black dots correspond to wells with 'blank' samples.")

```
::: callout-note
The figure above shows that the fluorescence intensity of S9 and S10 are systematically overlapping with the fluorescence intensity of the blanks wells. This suggests that S9 and S10 are not necessary.
:::



## Exclusion of failed analytes

We exclude the cytokines that do not have any values across all plates

```{r}

raw <- exclude_missing_analytes(raw)

```

## Imputation of out-of-range values

Lower and higher limits of quantification are defined as the lowest and highest concentrations of the standards whose concentration matches the expected concentration within 10 fold (LLOQ and ULOQ corresponds to the extremes of the blue dots in the graph below).


```{r}

raw <- impute_OOR(raw)

```

```{r}
#| fig-width: 30
#| fig-height: 10

raw@metadata$standards |>
  ggplot() +
  aes(x = exp_conc |> log2(), y = FI_wo_background |> asinh(), col = standard_category) +
  geom_point(alpha = 0.5) +
  facet_grid(str_c("plate: ", plate_nb) ~ .feature) +
  scale_color_manual("Category", values = c("black", "red", "steelblue1", "black")) +
  theme(
    legend.position = "top",
    strip.text.x = element_text(angle = 90, hjust = 0)
    ) 
  
```


```{r}
#| fig-width: 20
#| fig-height: 15

features_with_S9_or_S10_as_LLOQ <- 
  raw@metadata$standards |> 
  ungroup() |> 
  filter(standard_category == "LLOQ") |> 
  filter(sample_id %in% c("S9", "S10")) |> 
  select(.feature) |> 
  distinct() |> 
  pull(.feature)

raw |> 
  as_tibble() |> 
  filter(
    sample_type %in% c("Sample", "Standard"),
    .feature %in% features_with_S9_or_S10_as_LLOQ,
    ) |>
  select(plate_nb, .sample, sample_id, .feature, sample_type, FI, FI_wo_background, conc, value_type) |>
  left_join(
    raw@metadata$standards |> 
      select(plate_nb, .feature, .sample, standard_category) |> 
      distinct(),
    by = join_by(plate_nb, .sample, .feature)
    ) |> 
  mutate(
    sample_label =
      case_when(
        sample_type == "Standard" ~ sample_id |> str_remove("S"),
        TRUE ~ "o"
      )
  ) |> 
  ggplot() +
  aes(x = sample_type, y = FI_wo_background |> asinh(), 
      col = standard_category, alpha = sample_type) +
  geom_text(aes(label = sample_label)) +
  facet_grid(plate_nb ~ .feature) +
  scale_alpha_manual(values = c(0.1, 0.8)) +
  theme(strip.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5))

```


```{r}

ranges <- 
  raw@metadata$ranges |> 
  pivot_longer(c("LLOQ", "ULOQ", "mid"), names_to = "value_type", values_to = "concentration") |>
  mutate(value_type = value_type |> factor(levels = c("LLOQ", "mid", "ULOQ"))) |>
  arrange(plate_nb, value_type) 

```

```{r}

g_ranges <- 
  ranges |> 
  group_by(.feature) |> 
  mutate(mid = mean(concentration |> log2())) |> 
  ungroup() |> 
  arrange(mid) |> 
  mutate(.feature = .feature |> fct_inorder()) |>
  filter(value_type != "mid") |> 
  ggplot() +
  aes(x = .feature, y = concentration |> log2(), col = plate_nb |> factor()) +
  # ggbeeswarm::geom_quasirandom(size = 2, alpha = 0.5) +
  geom_text(aes(label = plate_nb), alpha = 0.5) +
  scale_color_discrete("Plate nb") +
  xlab("") +
  guides(col = "none") +
  theme(
    legend.position = "bottom", 
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  ) +
  ggtitle("Ranges of quantification for each analyte and plate (nb)")

g_ranges

```

```{r}

ranges |> 
  ungroup() |> 
  arrange(plate_nb) |> 
  mutate(plate = str_c("plate ", plate_nb) |> fct_inorder()) |>
  select(-plate_nb) |>
  group_by(.feature) |> 
  filter(value_type != "mid") |>
  dplyr::rename(` ` = value_type) |> 
  pivot_wider(names_from = "plate", values_from = "concentration") |>
  gt(row_group_as_column = TRUE)


```


```{r}

g_ranges +
  geom_point(
    data = raw |> as_tibble() |> filter(sample_type == "Sample") |> select(-value_type) |>  expand_grid(value_type = c("ULOQ", "LLOQ")),
    aes(y = conc |> log2()),
    size = 0.1, alpha = 0.1, col = "black"
    ) +
  labs(
    caption = "Tiny black dots are observed concentrations for samples"
    )


```



```{r}
#| fig-width: 10
#| fig-height: 7

raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample")  |> 
  ggplot() +
  aes(y = .feature, fill = value_type) +
  geom_bar() +
  facet_grid(. ~ str_c("plate: ", plate_nb)) +
  xlab("Number of samples") +
  ylab("") +
  scale_fill_manual("", breaks = value_types_levels(), values = value_types_colors()) 

```

Most analytes are within quantifiable range.

```{r}
#| fig-width: 10
#| fig-height: 7

raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample")  |> 
  mutate(well = str_c(plate_row, plate_col)) |>
  ggplot() +
  aes(y = well, fill = value_type) +
  geom_bar() +
  facet_grid(. ~ str_c("plate: ", plate_nb), scales = "free_y") +
  xlab("Number of samples") +
  ylab("") +
  scale_fill_manual("", breaks = value_types_levels(), values = value_types_colors()) 

```
Most samples have quantifiable concentrations, but we notice a few samples that may not have "worked" (i.e., that have a substantial number of analytes below the limit of quantification).

```{r}
#| fig-height: 10
#| fig-width: 10

samples <- 
  raw |> 
  as_tibble() |> 
  group_by(plate_nb, plate_row, plate_col, .sample, sample_id, sample_type, dilution, dilution_imputed) |> 
  summarize(n_OOR = sum(value_type != "Observed concentration"), .groups = "drop") |> 
  arrange(plate_col, plate_row) |> 
  mutate(well = str_c(plate_col, plate_row) |> fct_inorder()) 

samples |> 
  ggplot() +
  aes(x = well, y = n_OOR, fill = sample_type) +
  geom_col() +
  facet_wrap(plate_nb ~ .,  ncol = 1) 

```

```{r}

raw$n_OOR <- samples[match(colnames(raw), samples$.sample), "n_OOR"]

```




## Overview of concentrations by analyte

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "value_type")

```

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "sample_type")

```

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "plate_name")

```

# Data transformations

We next explore which transformation (no transformation, log, asinh, or square root) of the data is most suitable to stabilize the variance of the data.

```{r}
#| fig-width: 10
#| fig-height: 8

check_transformation(raw, transf = "none") +
check_transformation(raw, transf = "asinh") +
check_transformation(raw, transf = "log") +
check_transformation(raw, transf = "sqrt")

```

As expected, the `log` transformation appears to be the most suitable for stabilizing the variance of the data.

```{r}

assay(raw, "conc_log2") <- raw |> assay("conc") |> log2()

```


# QC Exploratory analyses

## Standards and controls

Comparison of standards and controls concentrations across plates (x-axis) and analytes (facets).

```{r}
#| fig-height: 10
#| fig-width: 14

raw |> 
  filter(sample_type %in% c("Standard", "Positive control", "Blank", "Manuf. control")) |> 
  ggplot() +
  aes(x = plate_nb |> factor(), y = conc_log2, col = sample_id, shape = sample_type) +
  geom_point(size = 1, alpha = 0.5) +
  facet_wrap(.feature ~ ., nrow = 3) +
  theme(legend.position = "bottom") +
  xlab("Plate nb") +
  ylab("log2(concentration)")

```

Comparison of biological controls (colored dots) across plates (x-axis) and analytes (facets) (constrasted with the distribution of samples in light gray):

```{r}
#| fig-height: 6
#| fig-width: 14

raw |> 
  filter((sample_id == "BIOL CTRL") | (sample_type == "Sample")) |> 
  mutate(plate_ctrl = ifelse(sample_id == "BIOL CTRL", plate_nb, NA) |> factor()) |>
  ggplot() +
  aes(x = plate_nb |> factor(), y = conc_log2, col = plate_ctrl, alpha = is.na(plate_ctrl), shape = (value_type == "Observed concentration")) +
  geom_point(size = 1) +
  facet_wrap(. ~ .feature |> str_remove("Hu ") |> str_remove("\\([0-9]*\\)"), nrow = 3) + # , scales = "free"
  scale_x_discrete(breaks = NULL) +
  scale_alpha_manual(values = c(1, 0.1)) +
  xlab("Plate nb") +
  ylab("log2(concentration)") + 
  scale_color_discrete("Plate nb") # + theme(strip.text.x = element_text(angle = 90, hjust = 0)) 


```


## Marginal distributions


```{r}

plot_marginals <- function(raw, by = "plate_nb", binwidth = 1){
  tmp <- raw |> as_tibble()
  tmp <- tmp |> bind_rows(tmp |> mutate(.feature = "all analytes"))
  tmp$by <- str_c(by ," ", tmp[[by]])
  
  min_c <- min(tmp$conc_log2[!is.infinite(tmp$conc_log2)], na.rm = TRUE)
  max_c <- max(tmp$conc_log2[!is.infinite(tmp$conc_log2)], na.rm = TRUE)

  tmp |> 
    mutate(
      conc_log2_bin = 
        conc_log2 |> 
        cut(breaks = seq(min_c, max_c, by = binwidth))
    ) |> 
    dplyr::count(by, .feature, conc_log2_bin) |>
    group_by(by, .feature) |> 
    mutate(f = n/sum(n)) |> 
    ggplot( ) +
    aes(x = conc_log2_bin, y = by, fill = by, alpha = f) +
    geom_tile() +
    facet_wrap(.feature ~ ., scale = "free") +
    labs(
      x = "log2(concentration)\n(independent scales per analyte)",
      y = by
    ) +
    scale_x_discrete(breaks = NULL) +
    guides(fill = "none") +
    theme(strip.text.y = element_text(angle = 0))
  
}
```


Per plate


```{r}
#| fig-height: 15
#| fig-width: 15

plot_marginals(raw, by = "plate_nb")

```



Per location

```{r}
#| fig-height: 11
#| fig-width: 15

plot_marginals(raw, by = "location")

```

Per visit

```{r}
#| fig-height: 15
#| fig-width: 15

plot_marginals(raw, by = "visit_nb")

```



## PCA


```{r}

complete_samples <- 
  raw |> 
  as_tibble() |> 
  group_by(.sample) |>
  summarize(ok = !any(is.na(conc_log2))) |>
  mutate(i = row_number()) |>
  filter(ok)

complete <- raw[, complete_samples$.sample]

```


```{r}

pca_res <- 
  prcomp(complete |> assay("conc_log2") |> t(), center = TRUE, scale = TRUE)

```

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48)

```

As often with Luminex data, the first component explains most of the variance.

Excluding the 1st component, we can then see that the variance decreases rapidly. 

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48) +
  geom_hline(yintercept = 100*1/48, linetype = 2) +
  ylim(c(0, 20))

```
```{r}

plot_pca_scores <- function(pca_res, raw, axes = 1:2, col_by = "sample_type"){
  scores <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    left_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)),
      by = join_by(.sample)
    )
  
  var <- factoextra::get_eig(pca_res)
  
  xvar <- str_c("PC", axes[1])
  yvar <- str_c("PC", axes[2])
  ggplot(scores) +
    aes(x = .data[[xvar]], y = .data[[yvar]], col = .data[[col_by]]) +
    geom_vline(xintercept = 0, col = "gray") +
    geom_hline(yintercept = 0, col = "gray") +
    geom_point(alpha = 0.8) +
    labs(
      x = str_c(xvar, " (", var$variance.percent[axes[1]] |> round(1), "%)"), 
      y = str_c(yvar, " (", var$variance.percent[axes[2]] |> round(1), "%)")
      ) +
    coord_fixed()
}

```


Checking the scores and biplots by sample type:

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "sample_type") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "sample_type") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "sample_type")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```
Focus on controls and standards:

```{r}
#| fig-height: 6
#| fig-width: 10

complete <- 
  complete |> 
  mutate(control_id = ifelse(sample_type == "Sample", NA, sample_id))

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "control_id") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "control_id") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "control_id")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Focus on the biological controls across plates:

```{r}
#| fig-height: 9
#| fig-width: 15

complete <- 
  complete |> 
  mutate(plate_biol_ctrl = ifelse(sample_id == "BIOL CTRL", plate_name, NA))

g_12 <- 
  plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_23 <- 
  plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")


g_45 <- 
  plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```

Plate effects?


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_name") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_name") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_name") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Plate effects when only considering samples (no controls or standards) that have at least 75% of their analytes within QR:


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 1:2, col_by = "plate_name") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 2:3, col_by = "plate_name") +
  stat_ellipse()

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 4:5, col_by = "plate_name") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Site differences?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "location") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "location") +
  stat_ellipse() 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "location") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Visit differences?

```{r}


complete <- complete |> mutate(visit = str_c("V", visit_nb))

visit_colors <- 
  c(
    "V1" = "red", "V2" = "green3", 
    "V3" = "steelblue1", "V4" = "steelblue2", "V5" = "steelblue3", "V6" = "steelblue4"
  )

```

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_23 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Effect of the dilution factor?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "dilution") +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "dilution")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "dilution")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


```{r}
#| fig-height: 6
#| fig-width: 10


g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "dilution_manifest") +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "dilution_manifest")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "dilution_manifest")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```



```{r}

scores_long <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    inner_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)) |> 
        pivot_longer(cols = -.sample, names_to = "PC", values_to = "value", names_prefix = "PC") |> 
        mutate(PC = PC |> as.integer()),
      by = join_by(.sample)
    )
  

```


```{r}
#| fig-width: 7
#| fig-height: 5

scores_long |> 
  filter(sample_type == "Sample", PC <= 6) |>
  ggplot(aes(x = dilution_manifest, y = value)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(PC ~ ., scales = "free", labeller = label_both) +
  ylab("PC score") +
  xlab("Dilution factor from manifest")



scores_long |> 
  filter(sample_type == "Sample", PC <= 6) |>
  ggplot(aes(x = dilution_manifest, y = value, col = location)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(PC ~ ., scales = "free", labeller = label_both) +
  ylab("PC score") +
  xlab("Dilution factor from manifest")


```


::: callout-caution
It looks like the correction for the dilution is a little too aggressive (samples with high dilution factors have higher concentrations on average).
:::


```{r}
#| fig-width: 7
#| fig-height: 5

scores_long |> 
  filter(sample_type == "Sample", PC <= 6) |>
  ggplot(aes(x = dilution_imputed, y = value)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(PC ~ ., scales = "free", labeller = label_both) +
  ylab("PC score") +
  xlab("Imputed dilution factor")


```

Are replicates close to each other?

```{r}
#| fig-height: 10
#| fig-width: 15

g_12 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 1:2, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 2:3, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 4:5, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```

```{r}
#| fig-height: 10
#| fig-width: 15

g_12 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 1:2, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 2:3, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 4:5, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```


## Marginal differences between replicates


```{r}

tmp <- 
  raw |> 
  as_tibble() |> 
  group_by(sample_id, .feature) |> 
  mutate(n = n()) |> 
  ungroup() |> 
  filter(n > 1, !is.na(conc_log2))

tmp <- 
  left_join(
    tmp |> 
      select(.feature, .sample, sample_id, sample_type, plate_nb, conc_log2) |> 
      dplyr::rename(.sample_r1 = .sample, plate_nb_r1 = plate_nb, conc_log2_r1 = conc_log2),
    tmp |> 
      select(.feature, .sample, sample_id, plate_nb, conc_log2) |> 
      dplyr::rename(.sample_r2 = .sample, plate_nb_r2 = plate_nb, conc_log2_r2 = conc_log2),
    by = join_by(.feature, sample_id),
    relationship = "many-to-many"
  ) |> 
  filter(.sample_r1 != .sample_r2)

```

```{r}

tmp <- 
  tmp |> 
  mutate(
    diff = conc_log2_r1 - conc_log2_r2,
    abs_diff = abs(diff),
    mean = (conc_log2_r1 + conc_log2_r2)/2,
    sd = sqrt(((conc_log2_r1 - mean)^2 + (conc_log2_r2 - mean)^2)),
    cv = sd/mean,
    replicate_type = ifelse(plate_nb_r1 == plate_nb_r2, "within plate", "across plate")
  )

```



```{r}
#| fig-height: 8
#| fig-width: 12

tmp |> 
  ggplot() +
  aes(x = diff, col = replicate_type) +
  geom_density(bw = 0.05) +
  facet_wrap(.feature ~ ., scales = "free") +
  scale_x_continuous(limits = c(-2.5, 2.5))
   
```


```{r}
#| fig-height: 6
#| fig-width: 5

tmp |> 
  filter(!is.infinite(diff)) |> 
  group_by(sample_type, plate_nb_r1, plate_nb_r2, replicate_type) |> 
  summarize(
    mean_abs_diff = mean(abs_diff),
    median_abs_diff = median(abs_diff),
    .groups = "drop"
    ) |> 
  ggplot() +
  aes(
    x = plate_nb_r1 |> factor(), 
    y = median_abs_diff, 
    col = plate_nb_r2 |> factor(),
    shape = replicate_type
    ) +
  geom_point() +
  facet_grid(sample_type ~ .) +
  xlab("Plate nb") +
  ylab("Median absolute difference between replicates") +
  scale_color_discrete("Replicate\nplate nb") + 
  scale_shape_discrete("Replicate type")
  
```


```{r}
#| fig-height: 7
#| fig-width: 10

tmp |> 
  # filter(sample_type == "Sample") |>
  ggplot() +
  aes(x = plate_nb_r2 |> factor(), y = abs_diff, col = replicate_type) +
  geom_boxplot(outlier.shape = NA) +
  ggbeeswarm::geom_quasirandom(size = 0.5, alpha = 0.1) +
  facet_grid(sample_type ~ plate_nb_r1, scales = "free", space = "free")
   
```


# Samples to re-run



I'd suggest to re-run the following samples:

- samples that have a substantial number of analytes below the limit of quantification

- samples that exhibit large differences between their replicates

- one V3 or V4 sample per participant for 1+ SA and 1+ US participant per plate (= 2-3 samples per plate) depending on material availability and space on plate.



```{r}


samples_to_rerun_OOR <- 
  colData(raw) |>
  as.data.frame() |>
  rownames_to_column(".sample") |>
  as_tibble() |> 
  filter(sample_type == "Sample", n_OOR > 12) |> 
  select(.sample, plate_nb, plate_row, plate_col, sample_id) |> 
  mutate(reason = "many OOR values")

```

```{r}

samples_with_large_differences_between_replicates <- 
  raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample") |> 
  group_by(sample_id) |>
  mutate(
    n_samples = length(unique(.sample)),
    n_plates = length(unique(plate_nb))
    ) |> 
  ungroup() |> 
  filter(n_samples >= 2) |> 
  group_by(sample_id, n_plates, .feature) |>
  summarize(
    max_n_OOR = max(n_OOR),
    log2_conc_diff_sq = sum((conc_log2 - mean(conc_log2))^2),
    .groups = "drop"
  ) |> 
  group_by(sample_id, max_n_OOR, n_plates) |>
  summarize(log2_conc_diff_sq = sum(log2_conc_diff_sq), .groups = "drop") 

samples_with_large_differences_between_replicates |> 
  ggplot() +
  aes(x = log2_conc_diff_sq |> sqrt(), fill = max_n_OOR > 12 ) +
  geom_histogram(bins = 30) +
  facet_grid(n_plates ~ .) 

samples_with_large_differences_between_replicates <- 
  samples_with_large_differences_between_replicates |> 
  filter(log2_conc_diff_sq > 100, max_n_OOR <= 12)

samples_with_large_differences_between_replicates <- 
  colData(raw) |>
  as.data.frame() |>
  rownames_to_column(".sample") |>
  as_tibble() |> 
  filter(sample_id %in% samples_with_large_differences_between_replicates$sample_id) |> 
  select(.sample, plate_nb, plate_row, plate_col, sample_id) |> 
  arrange(sample_id, plate_nb) |> 
  mutate(reason = "large differences between replicates")

```


```{r}

samples_to_rerun <- 
  bind_rows(samples_to_rerun_OOR, samples_with_large_differences_between_replicates) |> 
  group_by(.sample, plate_nb, plate_row, plate_col, sample_id) |> 
  summarize(reason = reason |> sort() |> str_c(collapse = ", "), .groups = "drop") 

```


```{r}

samples_to_rerun |> 
  ggplot() +
  aes(x = plate_row, y = plate_col, fill = reason) +
  geom_tile() +
  facet_wrap(. ~ plate_nb) 

```


```{r}

samples_to_rerun |>
  left_join(
    colData(raw) |> as.data.frame() |>  select(weight, volume, dilution, dilution_imputed)  |> rownames_to_column(".sample"),
  ) |> 
  arrange(sample_id) |> 
    mutate(i = row_number()) |> 
  select(i, everything()) |> 
  gt()

```

::: callout-caution
It looks like it's often all samples from the same participants that tend to fail. I wonder if there could be "properties" of the mucus from those participants that make them harder to quantify.
Maybe, the re-run won't help, but at least, since it seems that there is some "biological" origin to the "failed" samples, we should account for those in the analyses.
:::

That would be a total of `r nrow(samples_to_rerun)` samples to re-run + 2-3 samples per batch 1 plate (~20 samples) = `r nrow(samples_to_rerun) + 20` to add to the batch 2 samples and to randomly distribute across the batch 2 plates.

# Removing batch effects

> TODO

# Summarizing at the participant x visit level

> TODO

# Exporting the SE objects

> TODO


# MISC - Concentrations estimated using the imputed dilution factor

```{r}

raw <- 
  raw |> 
  mutate(
    unadjusted_conc = conc / dilution,
    conc_imputed = unadjusted_conc * (dilution_imputed |> replace_na(1)),
    conc_log2_imputed = log2(conc_imputed)
  )

```

```{r}

raw |> 
  as_tibble() |> 
  filter(!is.na(location)) |> 
  ggplot() +
  aes(x = conc_log2, y = conc_log2_imputed, col = location) +
  geom_point(size = 0.5, alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(.feature ~ .)

```



```{r}

complete_samples <- 
  raw |> 
  as_tibble() |> 
  group_by(.sample) |>
  summarize(ok = !any(is.na(conc_log2_imputed))) |>
  mutate(i = row_number()) |>
  filter(ok)

complete <- raw[, complete_samples$.sample]

```


```{r}

pca_res <- 
  prcomp(complete |> assay("conc_log2_imputed") |> t(), center = TRUE, scale = TRUE)

```

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48)

```

As often with Luminex data, the first component explains most of the variance.

Excluding the 1st component, we can then see that the variance decreases rapidly. 

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48) +
  geom_hline(yintercept = 100*1/48, linetype = 2) +
  ylim(c(0, 20))

```

```{r}

plot_pca_scores <- function(pca_res, raw, axes = 1:2, col_by = "sample_type"){
  scores <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    left_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)),
      by = join_by(.sample)
    )
  
  var <- factoextra::get_eig(pca_res)
  
  xvar <- str_c("PC", axes[1])
  yvar <- str_c("PC", axes[2])
  ggplot(scores) +
    aes(x = .data[[xvar]], y = .data[[yvar]], col = .data[[col_by]]) +
    geom_vline(xintercept = 0, col = "gray") +
    geom_hline(yintercept = 0, col = "gray") +
    geom_point(alpha = 0.8) +
    labs(
      x = str_c(xvar, " (", var$variance.percent[axes[1]] |> round(1), "%)"), 
      y = str_c(yvar, " (", var$variance.percent[axes[2]] |> round(1), "%)")
      ) +
    coord_fixed()
}

```


Checking the scores and biplots by sample type:

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "sample_type") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "sample_type") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "sample_type")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```
Focus on controls and standards:

```{r}
#| fig-height: 6
#| fig-width: 10

complete <- 
  complete |> 
  mutate(control_id = ifelse(sample_type == "Sample", NA, sample_id))

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "control_id") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "control_id") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "control_id")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Focus on the biological controls across plates:

```{r}
#| fig-height: 9
#| fig-width: 15

complete <- 
  complete |> 
  mutate(plate_biol_ctrl = ifelse(sample_id == "BIOL CTRL", plate_name, NA))

g_12 <- 
  plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_23 <- 
  plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")


g_45 <- 
  plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```
Plate effects?


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_name") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_name") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_name") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Plate effects when only considering samples (no controls or standards):


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "plate_name") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "plate_name") +
  stat_ellipse()

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "plate_name") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Site differences?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "location") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "location") +
  stat_ellipse() 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "location") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Visit differences?

```{r}


complete <- complete |> mutate(visit = str_c("V", visit_nb))

visit_colors <- 
  c(
    "V1" = "red", "V2" = "green3", 
    "V3" = "steelblue1", "V4" = "steelblue2", "V5" = "steelblue3", "V6" = "steelblue4"
  )

```

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_23 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Effect of the dilution factor?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "dilution_imputed") +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "dilution_imputed")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "dilution_imputed")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```




```{r}

scores_long <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    inner_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)) |> 
        pivot_longer(cols = -.sample, names_to = "PC", values_to = "value", names_prefix = "PC") |> 
        mutate(PC = PC |> as.integer()),
      by = join_by(.sample)
    )
  

```


```{r}
#| fig-width: 7
#| fig-height: 5

scores_long |> 
  filter(sample_type == "Sample", PC <= 6) |>
  ggplot(aes(x = dilution_imputed, y = value, col = location)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(PC ~ ., scales = "free", labeller = label_both) +
  ylab("PC score") +
  xlab("Imputed/recomputed dilution factor from actual weight and (imputed) volume")


```

Effect of the sample weight?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 1:2, col_by = "weight") +
  scale_color_gradient(low = "gray80", high = "purple") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 2:3, col_by = "weight")  +
  scale_color_gradient(low = "gray80", high = "purple") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 4:5, col_by = "weight")  +
  scale_color_gradient(low = "gray80", high = "purple") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 1:2, col_by = "weight") +
  scale_color_gradient(low = "gray80", high = "purple") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 2:3, col_by = "weight")  +
  scale_color_gradient(low = "gray80", high = "purple") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 4:5, col_by = "weight")  +
  scale_color_gradient(low = "gray80", high = "purple") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```



```{r}
#| fig-height: 6
#| fig-width: 10

complete <- 
  complete |> 
  mutate(
    w_per_v = weight / volume_imputed,
  )

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 1:2, col_by = "w_per_v") +
  scale_color_gradient(low = "gray80", high = "red") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 2:3, col_by = "w_per_v")  +
  scale_color_gradient(low = "gray80", high = "red") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "US"), axes = 4:5, col_by = "w_per_v")  +
  scale_color_gradient(low = "gray80", high = "red") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

```{r}
#| fig-height: 6
#| fig-width: 10

complete <- 
  complete |> 
  mutate(
    w_per_v = weight / volume_imputed,
  )

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 1:2, col_by = "w_per_v") +
  scale_color_gradient(low = "gray80", high = "red") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 2:3, col_by = "w_per_v")  +
  scale_color_gradient(low = "gray80", high = "red") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", location == "SA"), axes = 4:5, col_by = "w_per_v")  +
  scale_color_gradient(low = "gray80", high = "red") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```
---
title: "VIBRANT Luminex QC - batch 2"
author: Laura Symul
date: today
format: 
   html:
     page-layout: full
     code-fold: true
     toc: true
     toc-location: left
     toc-depth: 5
     embed-resources: true
execute:
  cache: refresh # true refresh false
  warning: false
knitr:
  opts_chunk:
    out.width: "100%"
editor: source
---

```{r}
#| warning: false

library(tidyverse)
library(magrittr)
library(gt)
library(patchwork)
library(SummarizedExperiment)
library(tidySummarizedExperiment)

tmp <- fs::dir_map("R scripts Luminex/", source)

theme_set(theme_light())

```

# Data

## Loading Luminex data

```{r}

VIBRANT_dropbox_dir <-
  "/Users/laurasymul/Dropbox/Academia/Projects/VIBRANT Study Files/"

luminex_dir <- 
  str_c(VIBRANT_dropbox_dir, "15_VIBRANT Luminex/VMRC VIBRANT LUMINEX Results_ONGOING/")
batch2_dir <- 
  str_c(luminex_dir, "Batch 2")


```

```{r}

plate_dirs <- list.files(batch2_dir, full.names = TRUE, pattern = "late [0-9]")

```

The data for the `r length(plate_dirs)` plates of Batch 2 were uploaded to the VIBRANT Dropbox by Lenine Liebenberg in April 2025 in the following directories:

```{r}
plate_dirs |> str_remove(".*Academia/Projects/")
```

The data was made available as excel files. In these directories, we find the following files:

```{r}

files <- list.files(plate_dirs, full.names = FALSE, pattern = "xlsx$")
files

```


::: callout-note
We only consider files that are of the form `[date]_SFT_LUM_VIBRANT_plate [0-9] optimized.xlsx` (*i.e.,* not considering the "unoptimized" or other files). 
:::

We load this data into R and store the excel sheets from the different plates in a single `SummarizedExperiment` object.

::: callout-note
I'm excluding plate 9 for now because the cytokines were named differently.
:::

```{r}

raw <- 
  read_luminex_excels(
    dirs = plate_dirs[-9],
    pattern = "SFT_LUM_VIBRANT_plate [0-9]* optimized\\.xlsx$",
    name = "VIBRANT batch 2"
    ) # 

raw

```

## Plate design and sample names

```{r}
#| fig-width: 12
#| fig-height: 5
#| fig-dpi: 300
plot_plate_design(raw) 

```

::: callout-note
Biological controls are not always named as such. I fix that manually below. 
:::

::: callout-note
Some sample name missing 

- plate 1 B12: X58
- plate 3 F8: X30
- plate 9 G10: X47.

I also fix that manually below, using data from the plate layout files.
@Lenine: could you check that I fixed that properly? 
:::


```{r}

raw <- 
  raw |> 
  mutate(
    sample_id = 
      case_when(
        sample_id == "X65"  ~ "BIOL CTRL",
        sample_id == "X58"  ~ "US_068100029_2120",
        sample_id == "X30"  ~ "US_068100050_1700",
        sample_id == "X47"  ~ "SA_068200366_1500",
        TRUE ~ sample_id
      )
  )

```


```{r}

raw <- 
  raw |> 
  mutate(
    sample_type = 
      case_when(
        str_detect(sample_id, " CTRL") ~ "Positive control", 
        TRUE ~ sample_type
        )
    )

```



## Loading manifest data

We load the data contained in the sheet `plate prep 2` from the `BATCH 2 LAYOUT - VMRC VIBRANT.xlsx` file.
At the moment, we only consider the data in `A2:AD527`.

```{r}

manifest <- 
  read_xlsx(
    str_c(batch2_dir, "/BATCH 2 LAYOUT - VMRC VIBRANT.xlsx"), 
    sheet = "plate prep 2", range = "A2:AG527"
  )

colnames(manifest)[1] <- "index"
colnames(manifest)[2] <- "new_or_rerun"

```

```{r}

manifest_col <- c("index", "new_or_rerun","full title", "shorthand title", "LOCATION", "Weight of vaginal fluid (gm)", "Original Softcup Volume (mL)", "Volume added for assay", "Round 1 Final dilution factor")

```


We subset and rename the column of interest (`r manifest_col |> str_c(collapse = ", ")`):

```{r}

manifest <- 
  manifest |> 
  select(manifest_col) |> 
  dplyr::rename(
    shorthand_title = `shorthand title`,
    sample_id = `full title`,
    location = LOCATION,
    weight = `Weight of vaginal fluid (gm)`,
    volume = `Original Softcup Volume (mL)`,
    volume_added_for_assay = `Volume added for assay`,
    dilution_manifest = `Round 1 Final dilution factor`
  )

manifest |> head() |> gt(caption = "Top rows of the manifest data after column selection and renaming.")

```




We create a `pid` (participant id), `visit_nb`, and `location` column with info extracted from the `sample_id`.

::: callout-warning
NOT CURRENTLY POSSIBLE BECAUSE SAMPLE ID FORMAT NOT CONSISTENT -> To discuss!

SKIP everything below -> Standard curves
:::

```{r}

# raw$pid <- 
#   ifelse(
#     str_detect(raw$sample_id, "^US|^SA"), 
#     raw$sample_id |> str_remove("SA_068-20-|US_068-10-") |> str_remove("_V[0-9].*"), 
#     NA
#     )
# raw$visit_nb <- 
#   raw$sample_id |> str_extract("V[0-9]*") |> str_remove("V") |> as.integer()
# raw$location <- raw$sample_id |> str_extract("^US|^SA") |> factor()

```

#### Sample weight, volume, and dilution factors

We also , `weight`, `volume`, `volume_added_for_assay`, and `dilution_manifest` columns in the `colData(raw)` data.

```{r}


# raw$dilution_manifest <- samples$dilution_manifest
# raw$weight <- samples$weight
# raw$volume <- samples$volume
# raw$volume_added_for_assay <- samples$volume_added_for_assay
# 
# rm(samples)

```


We compare the dilution factors from the excel file and the manifest:

```{r}
#| fig-width: 10
#| fig-height: 5

# colData(raw) |> 
#   as.data.frame() |> 
#   rownames_to_column(".sample") |>
#   as_tibble() |>
#   ggplot() +
#   aes(x = dilution, y = dilution_manifest, col = plate_name) +
#   geom_abline(intercept = 0, slope = 1, col = "gray80") +
#   geom_point(alpha = 0.5, size = 0.2) +
#   coord_fixed() +
#   labs(
#     x = "Dilution factor from Luminex excel file\n(dilution sheet)", 
#     y = "Dilution factor from manifest\nRound 1 Final dilution factor",
#     color = "Plate"
#     ) +
#   facet_wrap(plate_name |> str_replace_all("_", " ") |> str_wrap(20) ~ ., nrow = 2) +
#   guides(col = "none")
 
```



```{r}

# dilution_related_data <- 
#   colData(raw) |> 
#   as.data.frame() |>
#   rownames_to_column(".sample") |>
#   as_tibble() |>
#   filter(sample_type == "Sample") |> 
#   select(sample_id, location, pid, visit_nb, dilution, dilution_manifest, weight, volume) 

```


```{r}
# location_colors <- c("US" = "coral", "SA" = "steelblue3")
```


```{r}
#| fig-width: 10
#| fig-height: 5

# dilution_related_data |> 
#   ggplot() +
#   aes(x = weight, fill = location) +
#   geom_histogram(bins = 50, alpha = 0.5, position = "identity") +
#   scale_fill_manual(values = location_colors) +
#   xlab("Sample weight") +
#   ylab("n samples") +
#   
#   dilution_related_data |> 
#   ggplot() +
#   aes(x = volume, fill = location) +
#   geom_histogram(bins = 50, alpha = 0.5, position = "identity")  +
#   scale_fill_manual(values = location_colors) +
#   guides(fill = "none") +
#   xlab("Sample volume") +
#   ylab("n samples") +
#   
#   plot_layout(guides = "collect")


```

::: callout-note
Lenine has assumed that 1g = 1mL for **all** samples to compute the final dilution factors.
:::

However, when we examine the relationship between weight and volume in the US samples, we not not observe data compatible with that assumption:

```{r}
# 
# g_exact <- 
#   dilution_related_data |> 
#   ggplot() +
#   aes(y = volume, x = weight, col = location) +
#   geom_abline(intercept = 0, slope = 1) +
#   geom_point(alpha = 0.1) + 
#   coord_fixed() +
#   scale_color_manual(values = location_colors) +
#   guides(col = "none") 
# 
# g_jittered <-   
#   dilution_related_data |> 
#   ggplot() +
#   aes(y = volume, x= weight, col = location) +
#   geom_abline(intercept = 0, slope = 1) +
#   geom_jitter(height = 0.025, width = 0.025, size = 0.5, alpha = 0.5) +
#   coord_fixed() +
#   scale_color_manual(values = location_colors)

```


```{r}
#| fig-height: 12
#| fig-width: 8
# 
# mod <- lm(volume ~ weight, data = dilution_related_data)
# mod_label <- str_c("V = ", mod$coefficients[2] |> round(2), "W + ",mod$coefficients[1] |> round(2))
# 
# mod_color <- "purple"
# 
# g_exact + 
#   annotate(geom = "text", x = 1, y = 1, label = "1mL = 1g", col = "black", hjust = -0.1) +
#     ggtitle("(Exact coordinates)") +
#   g_jittered +
#   ggtitle("(Jittered coordinates)") +
#   
#   g_exact + 
#   geom_abline(slope = 1, intercept = 0.4, col = mod_color) + 
#   annotate(geom = "text", x = 0.8, y = 1.2, label = "V = W + 0.4", col = mod_color, hjust = 1.1, vjust = 0) +
#   ggtitle("Systematic bias in weight measurements") +
#   g_jittered + 
#   geom_abline(slope = 1, intercept = 0.4, col = mod_color) + 
#   annotate(geom = "text", x = 0.8, y = 1.2, label = "V = W + 0.4", col = mod_color, hjust = 1.1, vjust = 0) +
#   
#   g_exact + 
#   geom_abline(slope = mod$coefficients[2], intercept = mod$coefficients[1], col = mod_color) + 
#   annotate(geom = "text", x = 1, y = 1.2, label = mod_label, col = mod_color, hjust = 1.1, vjust = 0) +
#   ggtitle("Linear relationship between volume and weight") +
#   g_jittered + 
#   geom_abline(slope = mod$coefficients[2], intercept = mod$coefficients[1], col = mod_color) + 
#   annotate(geom = "text", x = 1, y = 1.2, label = mod_label, col = mod_color, hjust = 1.1, vjust = 0) +
#   
#   
#   g_exact + 
#   geom_smooth(method = "lm", formula = "y ~ x + I(x^2)", se = FALSE, col = mod_color) +
#   ggtitle("Quadratic relationship between volume and weight") +
#   g_jittered + 
#    geom_smooth(method = "lm", formula = "y ~ x + I(x^2)", se = FALSE, col = mod_color) +
#   
#   plot_layout(guides = "collect", ncol = 2)
# 

```

If we assume that the quadratic relationship between volume and weight observed in the US is generalizeable to SA samples, we can impute the SA samples' volume using the quadratic model, then, recalculate the dilution factors.

```{r}
# 
# mod2 <- lm(volume ~ weight + I(weight^2), data = dilution_related_data |> filter(location == "US"))
# pred_volume <- predict(mod2, newdata = tibble(weight = raw$weight))
# raw$volume_imputed <- ifelse((raw$location == "SA") & (raw$sample_type == "Sample"), pred_volume, raw$volume)

```

```{r}

# raw |> 
#   as_tibble() |> 
#   filter(sample_type == "Sample") |> 
#   select(sample_id, location, weight, volume_imputed) |> 
#   distinct() |> 
#   ggplot() +
#   aes(x = weight, y = volume_imputed, col = location) +
#   geom_abline(intercept = 0, slope = 1) +
#   geom_point(alpha = 0.1) + 
#   coord_fixed() +
#   scale_color_manual(values = location_colors)

```



To compute the dilution factor:

- $V_0$ is the volume of the softcup material in ml (measured only in the US);
- $V_1 = V_0 + 0.5$ml of buffer systematically added to all samples;
- A 200ul aliquot is taken from $V_1$ ($V_a$ = 200 ul);
- $d_a = \frac{V_1}{V_0}$ is the dilution factor of the aliquot;
- Lenine then adds for most (but not all) samples a volume of 250ul of buffer to the sample ($V_2$ = 250 ul) such that
- $V_2 = 200\mu l + V_a$ where $V_a$ is the volume of buffer Lenine added to the sample;
- $d_s = \frac{V_2}{200}$ is the dilution factor of the sample such that 
- $d = d_a d_s$ is the final dilution factor of the sample.



```{r}
# 
# raw <- 
#   raw |> 
#   mutate(
#     volume_manifest = weight,
#     dilution_aliquot_manifest = (volume_manifest + 0.5)/volume_manifest,
#     dilution_sample_manifest = (200 + volume_added_for_assay)/(200),
#     dilution_manifest_LS = dilution_aliquot_manifest * dilution_sample_manifest,
#     dilution_aliquot = (volume_imputed + 0.5)/volume_imputed,
#     dilution_sample = (200 + volume_added_for_assay)/(200),
#     dilution_imputed = dilution_aliquot * dilution_sample
#   )

```


```{r}
# 
# dilution_related_data <- 
#   colData(raw) |> 
#   as.data.frame() |>
#   rownames_to_column(".sample") |>
#   as_tibble() |>
#   filter(sample_type == "Sample") |> 
#   select(sample_id, location, pid, visit_nb, dilution, dilution_manifest, dilution_manifest_LS, dilution_imputed, weight, volume, volume_imputed, volume_added_for_assay)

```

```{r}

# ggplot(dilution_related_data) +
#   aes(
#     x = dilution_manifest, 
#     y = dilution_manifest_LS, 
#     col = location
#     ) +
#   geom_point(alpha = 0.5, size = 0.5) +
#   scale_color_manual(values = location_colors) +
#   scale_x_log10() +
#   scale_y_log10() +
#   xlab("Dilution (manifest values)") +
#   ylab("Dilution recalculated\nas in the manifest") +
#   coord_fixed()

```




```{r}

# dilution_related_data |> 
#   filter(location == "SA", dilution_imputed < 3, dilution > 10) |> 
#   gt()

```


```{r}

# ggplot(dilution_related_data) +
#   aes(
#     x = dilution_manifest, 
#     y = dilution_imputed, 
#     col = location
#     ) +
#   geom_point(alpha = 0.5, size = 0.5) +
#   scale_color_manual(values = location_colors) +
#   scale_x_log10() +
#   scale_y_log10() +
#   xlab("Dilution (manifest values)") +
#   ylab("Dilution (imputed values)\ncomputed from actual volumes in the US\nand imputed volumes in SA") +
#   coord_fixed()

```


```{r}

# ggplot(dilution_related_data) +
#   aes(
#     x = dilution_manifest, 
#     y = dilution_imputed, 
#     shape = location,
#     col = volume_added_for_assay |> factor()
#     ) +
#   geom_point(alpha = 0.5, size = 1) +
#   scale_x_log10() +
#   scale_y_log10() +
#   scale_color_discrete("Volume added by Lenine for assay") +
#   xlab("Dilution (manifest values)") +
#   ylab("Dilution (imputed values)\ncomputed from actual volumes in the US\nand imputed volumes in SA") +
#   coord_fixed()

```



```{r}

# ggplot(dilution_related_data) +
#   aes(x = dilution_manifest, y = dilution_imputed, col = weight |> log2(), shape = location) +
#   geom_point(alpha = 0.5, size = 0.8) +
#   scale_color_gradient(low = "red", high = "black") +
#   scale_x_log10() +
#   scale_y_log10() +
#   xlab("Dilution (manifest values)") +
#   ylab("Dilution (imputed values)\ncomputed from actual volumes in the US\nand imputed volumes in SA") +
#   coord_fixed()

```


::: callout-caution
There are marked differences between the dilution values as computed from the sample weight and those using the actual or imputed volume... The largest differences are observed when the measured weights were very small... Something to discuss :)

For now, I continue the analyses with the rounded dilution values that were provided in the excel files, but at the end of the document, I've done some of the analyses again using the imputed dilution values. I think that what would be the best course of action is to compute the "unadjusted concentrations" from those provided by the Luminex software (simply by dividing by the dilution factor that it used), impute the out-of-range values, then multiply these "unadjusted concentrations" by the computed/imputed dilution factors as done above to obtain our final estimates for the dilution-adjusted concentrations.
:::


So, for now, the current dilution values per plate and sample are:

```{r}
#| fig-height: 12

# raw |> plot_dilution_factors()

```



## Number of replicates per location, participants, and visits

```{r}
#| fig-height: 6
#| fig-width: 7

# colData(raw) |> 
#   as.data.frame() |> 
#   dplyr::count(location, pid, visit_nb) |> 
#   filter(!is.na(pid), !is.na(visit_nb)) |> 
#   pivot_wider(names_from = visit_nb, values_from = n, names_prefix = "V", values_fill = 0) |> 
#   gt(caption = "Number of samples per location, participant, and visit.")

# colData(raw) |> 
#   as.data.frame() |> 
#   dplyr::count(location, pid, visit_nb) |> 
#   filter(!is.na(pid), !is.na(visit_nb)) |>
#   arrange(visit_nb) |> 
#   mutate(
#     visit = str_c("V", visit_nb) |> fct_inorder(),
#     n = n |> factor()
#     ) |>
#   ggplot(aes(x = visit, y = pid, fill = n)) +
#   geom_tile() +
#   facet_wrap(. ~ location, scales = "free") +
#   scale_fill_manual(name = "Number of samples", values = c("steelblue1", "steelblue3")) +
#   ylab("Participant IDs")

```


## Exclusion of failed analytes

We exclude the cytokines that do not have any values across all plates

```{r}

raw <- exclude_missing_analytes(raw)

```

# Standards and standard curves

## Standards

```{r}
#| fig-width: 18
#| fig-height: 10

raw |> plot_standard_curves() 

```
Looks good.

```{r}
#| fig-width: 8
#| fig-height: 5

raw |> filter(.feature %in% "Hu IL-7 (74)") |> 
  plot_standard_curves() + 
  facet_wrap(. ~ plate_name + .feature) + 
  guides(col = "none") +
  ggtitle("Standard curves for Hu IL-7 (74) as example")

```


```{r}
#| fig-width: 8
#| fig-height: 5

raw |> filter(.feature %in% "Hu MIP-1b (18)") |> 
  plot_standard_curves() + 
  facet_wrap(. ~ plate_name + .feature) + 
  guides(col = "none") +
  ggtitle("Standard curves for Hu MIP-1b (18) as example")

```

```{r}
#| fig-height: 10
#| fig-width: 10

blanks <- 
  raw |> 
  as_tibble() |> 
  filter(sample_type == "Blank") |> 
  group_by(.feature) |> 
  mutate(median_FI = median(FI)) |> 
  ungroup() |> 
  arrange(median_FI) |> 
  mutate(.feature = .feature |> fct_inorder()) 

raw |> 
  as_tibble() |> 
  filter(sample_type == "Standard") |> 
  mutate(
    sample_id = sample_id |> factor(levels = str_c("S", 1:10)),
    .feature = .feature |> factor(levels = blanks$.feature |> levels())
    ) |>
  ggplot() +
  aes(x = .feature, y = FI, col = plate_nb |> factor()) +
  geom_hline(yintercept = 1, linetype = 1) +
  geom_point(data = blanks |> select(.feature, plate_nb, FI), alpha = 0.5, size = 0.5, col = "black") +
  geom_point(alpha = 0.5, size = 0.9) +
  facet_grid(sample_id ~ fct_inorder(str_c("plate: ", plate_nb)), scales = "free_y") +
  guides(col = "none") +
  scale_y_log10("Fluorescence intensity") +
  scale_x_discrete("Analytes, ordered by median FI in blank samples", breaks = NULL) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(caption = "Colored dots correspond to wells with standards, black dots correspond to wells with 'blank' samples.")

```
::: callout-note
Plate 5 looks a bit funny - the blanks are more variable.
:::



## Standard curves and sample concentrations

Below, we check the relationship between Fluorescence intensity (FI with background removed), and calculated concentration (in log2 scale) for the samples against the standard curves (for which we show the expected concentrations). 

```{r}

raw <- format_obs_conc(raw)

```

```{r}
#| eval: false
#| fig-width: 10
#| fig-height: 30

raw |> 
  as_tibble() |> 
  filter(sample_type == "Standard") |> 
  ggplot() +
  aes(
    x = exp_conc |> log2(),
    y = FI_wo_background |> asinh(),
    col = value_type, shape = value_type
      ) +
  geom_point() +
  facet_grid(.feature ~ str_c("plate:", plate_nb)) +
  scale_color_manual(breaks = value_types_levels(), values = value_types_colors()) +
  scale_shape_manual(breaks = value_types_levels(), values = value_types_shapes()) +
  theme(strip.text.y = element_text(angle = 0)) 


```

```{r}
#| fig-width: 12
#| fig-height: 4

map(raw@NAMES, ~plot_samples_on_standard_curves(se = raw, feature = .x))

```
Looks fine but need to check in more details.



```{r}
#| fig-width: 10
#| fig-height: 10

raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample", value_type == "Observed concentration") |>
  ggplot() +
  aes(
    x = (raw_obs_conc_num/dilution) |> log2(), 
    y = FI_wo_background |> asinh(),
    col = plate_nb |> factor()
    ) +
  geom_point(size = 0.5, alpha = 0.5) +
  facet_wrap(. ~ .feature)


raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample", value_type == "Observed concentration") |>
  ggplot() +
  aes(
    x = (raw_obs_conc_num/dilution) |> log2(), 
    y = plate_nb |> factor() |> fct_rev(),
    col = plate_nb |> factor()
    ) +
  geom_point(size = 0.5, alpha = 0.1) +
  facet_wrap(. ~ .feature)
  
```

Plate 5 looks a bit different. I wonder if that is because of how the background level is computed. There might have been some contamination in one of the blank on that plate.

> TODO: compute what the background level used by the Luminex software is and see whether the level for plate 5 is affected by that outlier.

```{r}
#| fig-width: 10
#| fig-height: 7

raw |> 
  filter(sample_type == "Sample") |>
  as_tibble() |> 
  mutate(value_type = value_type |> factor(levels = value_types_levels())) |> 
  ggplot() +
  aes(y = .feature, fill = value_type) +
  geom_bar() +
  facet_grid(. ~ plate_nb) +
  scale_fill_manual(
    "", 
    breaks = value_types_levels(),
    values = value_types_colors()
    ) +
  ylab("") +
  xlab("Number of samples per plate")

```

Most analytes are within quantifiable range, but we will probably need to exclude IL-13, and potentially IL-1ra, as they have many samples outside the limit of quantification.


```{r}
#| fig-width: 10
#| fig-height: 7

raw |> 
  as_tibble() |> 
  filter(sample_type == "Sample")  |> 
  arrange(plate_row, plate_col) |> 
  mutate(well = str_c(plate_row, plate_col) |> fct_inorder()) |>
  ggplot() +
  aes(y = well |> fct_rev(), fill = value_type) +
  geom_bar() +
  facet_grid(. ~ str_c("plate: ", plate_nb), scales = "free_y") +
  xlab("Number of analytes") +
  ylab("Plate well") +
  scale_fill_manual("", breaks = value_types_levels(), values = value_types_colors()) 

```

Most samples (wells) have quantifiable concentrations, but we notice a few samples that may have "failed" (*i.e.,* that have a substantial number of analytes below the limit of quantification or not quantified at all).


```{r}
#| fig-height: 10
#| fig-width: 10

samples <- 
  raw |> 
  as_tibble() |> 
  group_by(plate_nb, plate_row, plate_col, .sample, sample_id, sample_type, dilution) |> 
  summarize(n_OOR = sum(value_type != "Observed concentration"), .groups = "drop") |> 
  arrange(plate_col, plate_row) |> 
  mutate(well = str_c(plate_col, plate_row) |> fct_inorder()) 

samples |> 
  ggplot() +
  aes(x = well, y = n_OOR, fill = sample_type) +
  geom_col() +
  facet_wrap(plate_nb ~ .,  ncol = 1) +
  ylab("Number of analytes out of range") + 
  scale_fill_discrete("Sample type") +
  theme(
    axis.text.x = element_text(angle = 90, size = 7, vjust = 0.5, hjust = 1)
  )

```

```{r}

raw$n_OOR <- samples[match(colnames(raw), samples$.sample), "n_OOR"]

```



## Imputation of out-of-range values

Samples that are considered as out-of-range (per the Luminex software output) have been imputed to $0$ and $\infty$ at the previous step. 
It might make more sense for some downstream analyses to impute them to

- [below LLOQ] 1/2 the smallest extrapolated sample or standard concentration for that analyte and plate, multiplied by the dilution factor; and 
- [above ULOQ] 110% the largest extrapolated sample or standard concentration for that analyte and plate, multiplied by the dilution factor.


```{r}

raw <- impute_OOR(raw)

```




## Overview of concentrations by analyte

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "value_type")

```

The reason why some "below LLOQ" values are above "observed concentration" values is because the concentrations computed from the standard curves were multiplied by the dilution factor. One should be extremely careful when deciding to include values that were imputed for downstream analyses.

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "sample_type")

```

```{r}
#| fig-width: 10
#| fig-height: 5

plot_conc_by_analyte(raw, color_by = "plate_name")

```

# Data transformations

We next explore which transformation (no transformation, log, asinh, or square root) of the data is most suitable to stabilize the variance of the data.

```{r}
#| fig-width: 10
#| fig-height: 8

check_transformation(raw, transf = "none") +
check_transformation(raw, transf = "asinh") +
check_transformation(raw, transf = "log") +
check_transformation(raw, transf = "sqrt")

```

As expected, the `log` transformation appears to be the most suitable for stabilizing the variance of the data.

```{r}

assay(raw, "conc_log2") <- raw |> assay("conc") |> log2()

```


# QC Exploratory analyses

## Standards and controls

Comparison of standards and controls concentrations across plates (x-axis) and analytes (facets).

```{r}
#| fig-height: 10
#| fig-width: 14

raw |> 
  as_tibble() |> 
  filter(sample_type %in% c("Standard", "Positive control", "Manuf. control")) |> 
  mutate(
    sample_type = 
      case_when(
        sample_type == "Positive control" ~ sample_id,
        TRUE ~ sample_type
      )
  ) |> 
  ggplot() +
  aes(x = plate_nb |> factor(), y = conc_log2, col = sample_type) +
  geom_point(size = 1, alpha = 0.5) +
  facet_wrap(.feature ~ ., nrow = 3) +
  theme(legend.position = "top") +
  xlab("Plate nb") +
  ylab("log2(concentration)")

```

Comparison of biological controls (colored dots) across plates (x-axis) and analytes (facets) (constrasted with the distribution of samples in light gray):

```{r}
#| fig-height: 6
#| fig-width: 14

raw |> 
  filter((sample_id == "BIOL CTRL") | (sample_type == "Sample")) |> 
  mutate(plate_ctrl = ifelse(sample_id == "BIOL CTRL", plate_nb, NA) |> factor()) |>
  ggplot() +
  aes(x = plate_nb |> factor(), y = conc_log2, col = plate_ctrl, alpha = is.na(plate_ctrl), shape = (value_type == "Observed concentration")) +
  geom_point(size = 1) +
  facet_wrap(. ~ .feature |> str_remove("Hu ") |> str_remove("\\([0-9]*\\)"), nrow = 3) + # , scales = "free"
  scale_x_discrete(breaks = NULL) +
  scale_alpha_manual(values = c(1, 0.1)) +
  xlab("Plate nb") +
  ylab("log2(concentration)") + 
  scale_color_discrete("Plate nb") # + theme(strip.text.x = element_text(angle = 90, hjust = 0)) 


```
Biological controls are a bit too low (probably because they were from CVL, not from softcups).

## Marginal distributions


```{r}

plot_marginals <- function(raw, by = "plate_nb", binwidth = 1){
  tmp <- raw |> as_tibble()
  tmp <- tmp |> bind_rows(tmp |> mutate(.feature = "all analytes"))
  tmp$by <- str_c(by ," ", tmp[[by]])
  
  min_c <- min(tmp$conc_log2[!is.infinite(tmp$conc_log2)], na.rm = TRUE)
  max_c <- max(tmp$conc_log2[!is.infinite(tmp$conc_log2)], na.rm = TRUE)

  tmp |> 
    mutate(
      conc_log2_bin = 
        conc_log2 |> 
        cut(breaks = seq(min_c, max_c, by = binwidth))
    ) |> 
    dplyr::count(by, .feature, conc_log2_bin) |>
    group_by(by, .feature) |> 
    mutate(f = n/sum(n)) |> 
    ggplot( ) +
    aes(x = conc_log2_bin, y = by, fill = by, alpha = f) +
    geom_tile() +
    facet_wrap(.feature ~ ., scale = "free") +
    labs(
      x = "log2(concentration)\n(independent scales per analyte)",
      y = by
    ) +
    scale_x_discrete(breaks = NULL) +
    guides(fill = "none") +
    theme(strip.text.y = element_text(angle = 0))
  
}
```


Per plate


```{r}
#| fig-height: 15
#| fig-width: 15

plot_marginals(raw, by = "plate_nb")

```



Per location

```{r}
#| fig-height: 11
#| fig-width: 15

plot_marginals(raw, by = "location")

```

Per visit

```{r}
#| fig-height: 15
#| fig-width: 15

plot_marginals(raw, by = "visit_nb")

```



## PCA


```{r}

complete_samples <- 
  raw |> 
  as_tibble() |> 
  group_by(.sample) |>
  summarize(ok = !any(is.na(conc_log2))) |>
  mutate(i = row_number()) |>
  filter(ok)

complete <- raw[, complete_samples$.sample]

```


```{r}

pca_res <- 
  prcomp(complete |> assay("conc_log2") |> t(), center = TRUE, scale = TRUE)

```

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48)

```

As often with Luminex data, the first component explains most of the variance.

Excluding the 1st component, we can then see that the variance decreases rapidly. 

```{r}
#| fig-height: 3
#| fig-width: 9

factoextra::fviz_eig(pca_res, ncp = 48) +
  geom_hline(yintercept = 100*1/48, linetype = 2) +
  ylim(c(0, 20))

```
```{r}

plot_pca_scores <- function(pca_res, raw, axes = 1:2, col_by = "sample_type"){
  scores <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    left_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)),
      by = join_by(.sample)
    )
  
  var <- factoextra::get_eig(pca_res)
  
  xvar <- str_c("PC", axes[1])
  yvar <- str_c("PC", axes[2])
  ggplot(scores) +
    aes(x = .data[[xvar]], y = .data[[yvar]], col = .data[[col_by]]) +
    geom_vline(xintercept = 0, col = "gray") +
    geom_hline(yintercept = 0, col = "gray") +
    geom_point(alpha = 0.8) +
    labs(
      x = str_c(xvar, " (", var$variance.percent[axes[1]] |> round(1), "%)"), 
      y = str_c(yvar, " (", var$variance.percent[axes[2]] |> round(1), "%)")
      ) +
    coord_fixed()
}

```


Checking the scores and biplots by sample type:

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "sample_type") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "sample_type") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "sample_type")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```
Focus on controls and standards:

```{r}
#| fig-height: 6
#| fig-width: 10

complete <- 
  complete |> 
  mutate(control_id = ifelse(sample_type == "Sample", NA, sample_id))

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "control_id") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "control_id") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "control_id")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Focus on the biological controls across plates:

```{r}
#| fig-height: 9
#| fig-width: 15

complete <- 
  complete |> 
  mutate(plate_biol_ctrl = ifelse(sample_id == "BIOL CTRL", plate_name, NA))

g_12 <- 
  plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_23 <- 
  plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")


g_45 <- 
  plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_biol_ctrl") +
  scale_color_discrete(na.value = "gray90")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "n_OOR") +
  scale_color_gradient("Number of out-of-range values", low = "gray90", high = "red")

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```

Plate effects?


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- plot_pca_scores(pca_res, complete, axes = 1:2, col_by = "plate_name") 

g_23 <- plot_pca_scores(pca_res, complete, axes = 2:3, col_by = "plate_name") 

g_45 <- plot_pca_scores(pca_res, complete, axes = 4:5, col_by = "plate_name") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Plate effects when only considering samples (no controls or standards) that have at least 75% of their analytes within QR:


```{r}
#| fig-height: 7
#| fig-width: 12

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 1:2, col_by = "plate_name") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 2:3, col_by = "plate_name") +
  stat_ellipse()

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 12), axes = 4:5, col_by = "plate_name") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Site differences?

```{r}
#| eval: false
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "location") +
  stat_ellipse()

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "location") +
  stat_ellipse() 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "location") +
  stat_ellipse()
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```

Visit differences?

```{r}
#| eval: false

complete <- complete |> mutate(visit = str_c("V", visit_nb))

visit_colors <- 
  c(
    "V1" = "red", "V2" = "green3", 
    "V3" = "steelblue1", "V4" = "steelblue2", "V5" = "steelblue3", "V6" = "steelblue4"
  )

```

```{r}
#| eval: false
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_23 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "visit") +
  stat_ellipse() +
  scale_color_manual(values = visit_colors) 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


Effect of the dilution factor?

```{r}
#| fig-height: 6
#| fig-width: 10

g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "dilution") +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "dilution")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "dilution")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))

```


```{r}
#| eval: false
#| fig-height: 6
#| fig-width: 10


g_12 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 1:2, col_by = "dilution_manifest") +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 2:3, col_by = "dilution_manifest")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample"), axes = 4:5, col_by = "dilution_manifest")  +
  scale_color_gradient(low = "gray80", high = "dodgerblue") 
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```



```{r}

scores_long <- 
    colData(raw) |> 
    as.data.frame() |> 
    rownames_to_column(".sample") |> 
    as_tibble() |> 
    inner_join(
      as_tibble(pca_res$x) |> 
        mutate(.sample = rownames(pca_res$x)) |> 
        pivot_longer(cols = -.sample, names_to = "PC", values_to = "value", names_prefix = "PC") |> 
        mutate(PC = PC |> as.integer()),
      by = join_by(.sample)
    )
  

```


```{r}
#| fig-width: 7
#| fig-height: 5

scores_long |> 
  filter(sample_type == "Sample", PC <= 6) |>
  ggplot(aes(x = dilution, y = value)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(PC ~ ., scales = "free", labeller = label_both) +
  ylab("PC score") +
  xlab("Dilution factor")



```


::: callout-caution
Here as well, tt looks like the correction for the dilution is a little too aggressive (samples with high dilution factors have higher concentrations on average).
:::


Are replicates close to each other?

```{r}
#| fig-height: 10
#| fig-width: 15

g_12 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 1:2, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 2:3, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 4:5, col_by = "sample_id") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```

```{r}
#| fig-height: 10
#| fig-width: 15

g_12 <- 
 plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 1:2, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_23 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 2:3, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")

g_45 <- 
  plot_pca_scores(pca_res, complete |> filter(sample_type == "Sample", n_OOR < 5), axes = 4:5, col_by = "plate_name") +
  geom_path(aes(group = sample_id)) +
  guides(col = "none")
  

g_12 / (g_23 | g_45) +
  plot_layout(guides = "collect", heights = c(1, 1.5))


```


## Marginal differences between replicates


```{r}

tmp <- 
  raw |> 
  as_tibble() |> 
  group_by(sample_id, .feature) |> 
  mutate(n = n()) |> 
  ungroup() |> 
  filter(n > 1, !is.na(conc_log2))

tmp <- 
  left_join(
    tmp |> 
      select(.feature, .sample, sample_id, sample_type, plate_nb, conc_log2) |> 
      dplyr::rename(.sample_r1 = .sample, plate_nb_r1 = plate_nb, conc_log2_r1 = conc_log2),
    tmp |> 
      select(.feature, .sample, sample_id, plate_nb, conc_log2) |> 
      dplyr::rename(.sample_r2 = .sample, plate_nb_r2 = plate_nb, conc_log2_r2 = conc_log2),
    by = join_by(.feature, sample_id),
    relationship = "many-to-many"
  ) |> 
  filter(.sample_r1 != .sample_r2)

```

```{r}

tmp <- 
  tmp |> 
  mutate(
    diff = conc_log2_r1 - conc_log2_r2,
    abs_diff = abs(diff),
    mean = (conc_log2_r1 + conc_log2_r2)/2,
    sd = sqrt(((conc_log2_r1 - mean)^2 + (conc_log2_r2 - mean)^2)),
    cv = sd/mean,
    replicate_type = ifelse(plate_nb_r1 == plate_nb_r2, "within plate", "across plate")
  )

```



```{r}
#| fig-height: 8
#| fig-width: 12

tmp |> 
  ggplot() +
  aes(x = diff, col = replicate_type) +
  geom_density(bw = 0.05) +
  facet_wrap(.feature ~ ., scales = "free") +
  scale_x_continuous(limits = c(-2.5, 2.5))
   
```


```{r}
#| fig-height: 6
#| fig-width: 5

tmp |> 
  filter(!is.infinite(diff)) |> 
  group_by(sample_type, plate_nb_r1, plate_nb_r2, replicate_type) |> 
  summarize(
    mean_abs_diff = mean(abs_diff),
    median_abs_diff = median(abs_diff),
    .groups = "drop"
    ) |> 
  ggplot() +
  aes(
    x = plate_nb_r1 |> factor(), 
    y = median_abs_diff, 
    col = plate_nb_r2 |> factor(),
    shape = replicate_type
    ) +
  geom_point() +
  facet_grid(sample_type ~ .) +
  xlab("Plate nb") +
  ylab("Median absolute difference between replicates") +
  scale_color_discrete("Replicate\nplate nb") + 
  scale_shape_discrete("Replicate type")
  
```


```{r}
#| fig-height: 7
#| fig-width: 10

tmp |> 
  # filter(sample_type == "Sample") |>
  ggplot() +
  aes(x = plate_nb_r2 |> factor(), y = abs_diff, col = replicate_type) +
  geom_boxplot(outlier.shape = NA) +
  ggbeeswarm::geom_quasirandom(size = 0.5, alpha = 0.1) +
  facet_grid(sample_type ~ plate_nb_r1, scales = "free", space = "free")
   
```

